{% extends 'base.html' %}
{% block title %}My Bookings - SkillLink{% endblock %}

{% block content %}
<div class="container mt-5 max-w-4xl">

  <h1 class="text-center mb-5 fw-bold animate__animated animate__fadeInDown text-theme">My Bookings</h1>

  <h2 class="fw-semibold mb-3 animate__animated animate__fadeInLeft text-theme">Incoming Booking Requests</h2>
  {% for booking in bookings_received %}
  <div class="card booking-card shadow mb-4 animate__animated animate__fadeInUp">
    <div class="card-body">
      <p><strong>Skill:</strong> {{ booking.skill.name }}</p>
      <p><strong>Status:</strong> 
        <span class="badge bg-info text-dark">{{ booking.status|capfirst }}</span>
      </p>
      <p><strong>Requester:</strong> {{ booking.requester.user.get_full_name|default:booking.requester.user.username }}</p>

      <p><strong>Proposed Times:</strong></p>
      <ul>
        {% for h in booking.history.all %}
        <li>{{ h.proposed_time|date:"D, d M Y H:i" }}</li>
        {% endfor %}
      </ul>

      <div class="d-flex flex-wrap gap-2 mt-2">
        {% if booking.status == 'pending' %}
          <a href="{% url 'schedule_meeting' booking.id %}" class="btn btn-success fw-bold shadow-sm">Accept & Schedule</a>
          <a href="{% url 'booking_update_status' booking.id 'reject' %}" class="btn btn-danger fw-bold shadow-sm">Reject</a>
        {% elif booking.status == 'scheduled' %}
          {% if booking.provider.user == user %}
            <a href="{% url 'start_meeting' booking.id %}" target="_blank" class="btn btn-primary fw-bold shadow-sm">Start Zoom</a>
          {% elif booking.requester.user == user %}
            {% if booking.meeting_started %}
              <a href="{{ booking.meeting_link }}" target="_blank" class="btn btn-success fw-bold shadow-sm">Join Zoom</a>
            {% else %}
              <p class="fw-semibold">Waiting for host to start the meeting...</p>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-theme">No incoming bookings.</p>
  {% endfor %}

  <h2 class="fw-semibold mb-3 mt-5 animate__animated animate__fadeInLeft text-theme">My Bookings (Requested)</h2>
  {% for booking in bookings_made %}
  <div class="card booking-card shadow mb-4 animate__animated animate__fadeInUp">
    <div class="card-body">
      <p><strong>Skill:</strong> {{ booking.skill.name }}</p>
      <p><strong>Status:</strong> 
        <span class="badge bg-info text-dark">{{ booking.status|capfirst }}</span>
      </p>
      <p><strong>Provider:</strong> {{ booking.provider.user.get_full_name|default:booking.provider.user.username }}</p>

      <p><strong>Proposed Times:</strong></p>
      <ul>
        {% for h in booking.history.all %}
        <li>{{ h.proposed_time|date:"D, d M Y H:i" }}</li>
        {% endfor %}
      </ul>

      <div class="d-flex flex-wrap gap-2 mt-2">
        {% if booking.status == 'pending' %}
          <a href="{% url 'booking_update_status' booking.id 'cancel' %}" class="btn btn-warning fw-bold shadow-sm">Cancel</a>
        {% elif booking.status == 'scheduled' %}
          {% if booking.requester.user == user %}
            {% if booking.meeting_started %}
              <a href="{{ booking.meeting_link }}" target="_blank" class="btn btn-success fw-bold shadow-sm">Join Zoom</a>
            {% else %}
              <p class="fw-semibold">Waiting for host to start the meeting...</p>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-theme">No bookings made yet.</p>
  {% endfor %}
</div>

<!-- Animate CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<!-- Dark Mode Styling -->
<style>
  body.dark-mode {
    background-color: #121212;
    color: #eaeaea;
  }

  body.dark-mode .card.booking-card {
    background-color: #1e1e1e;
    border: 1px solid #333;
    color: #eaeaea;
  }

  body.dark-mode .btn {
    color: #fff !important;
  }

  .text-theme {
    color: inherit;
  }
</style>

<!-- Optional Toggle Button -->
<script>
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
  }

  // Remember mode
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }
  });
</script>

{% endblock %}
