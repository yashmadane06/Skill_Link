<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>

<script>
const ws = new WebSocket(`ws://${window.location.host}/ws/meet/{{ booking.id }}/`);
let pc = new RTCPeerConnection();

navigator.mediaDevices.getUserMedia({ video:true, audio:true }).then(stream=>{
    document.getElementById('localVideo').srcObject = stream;
    stream.getTracks().forEach(track=>pc.addTrack(track, stream));
});

pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

ws.onmessage = async (e) => {
    const data = JSON.parse(e.data);
    if(data.sdp){ await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if(data.sdp.type=='offer'){const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); ws.send(JSON.stringify({'sdp': pc.localDescription}));}
    } else if(data.ice){await pc.addIceCandidate(data.ice);}
};

pc.onicecandidate = e=>{if(e.candidate) ws.send(JSON.stringify({ice:e.candidate}));}

// create offer if provider
{% if request.user.profile==booking.provider %}
pc.createOffer().then(offer=>{pc.setLocalDescription(offer); ws.send(JSON.stringify({'sdp':offer}));});
{% endif %}
</script>
